<!DOCTYPE html>
<html lang="th">

<head>

    <meta charset="UTF-8">
    Â  Â 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    Â  Â  <title>à¸ˆà¸³à¸¥à¸­à¸‡à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡ Royal Run (à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡)</title>
    Â  Â  <style>
        /* CSS styles */
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: sans-serif;
            flex-direction: column;
            /* à¸ˆà¸±à¸”à¸­à¸‡à¸„à¹Œà¸›à¸£à¸°à¸à¸­à¸šà¹ƒà¸«à¹‰à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¹à¸™à¸§à¸•à¸±à¹‰à¸‡ */
        }

        #map-container {
            width: 600px;
            /* à¸„à¸§à¸²à¸¡à¸à¸§à¹‰à¸²à¸‡à¸‚à¸­à¸‡à¹à¸œà¸™à¸—à¸µà¹ˆà¸ˆà¸³à¸¥à¸­à¸‡ */
            height: 400px;
            /* à¸„à¸§à¸²à¸¡à¸ªà¸¹à¸‡à¸‚à¸­à¸‡à¹à¸œà¸™à¸—à¸µà¹ˆà¸ˆà¸³à¸¥à¸­à¸‡ */
            background-image: url('img/1.png');
            /* à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹ƒà¸«à¹‰à¹à¸™à¹ˆà¹ƒà¸ˆà¸§à¹ˆà¸² path à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ */
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            border: 1px solid #ccc;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: crosshair;
            /* à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ cursor à¹€à¸¡à¸·à¹ˆà¸­à¸­à¸¢à¸¹à¹ˆà¸šà¸™à¹à¸œà¸™à¸—à¸µà¹ˆ */
        }

        #routeCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #bus {
            width: 15px;
            height: 15px;
            background-color: rgb(155, 28, 75);
            /* à¸ªà¸µà¹à¸”à¸‡ */
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
            transition: transform 0.1s linear;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
            z-index: 2;
            opacity: 1;
        }

        .hidden {
            opacity: 0;
            transition: opacity 0s;
        }

        #controls {
            margin-top: 20px;
            text-align: center;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        button:hover {
            background-color: #e0e0e0;
        }

        /* à¸ªà¹„à¸•à¸¥à¹Œà¸ªà¸³à¸«à¸£à¸±à¸šà¸›à¸¸à¹ˆà¸¡à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸š */
        #backButtonContainer {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            /* à¹ƒà¸«à¹‰à¸­à¸¢à¸¹à¹ˆà¹€à¸«à¸™à¸·à¸­à¸—à¸¸à¸à¸­à¸¢à¹ˆà¸²à¸‡ */
            display: none;
            /* à¸‹à¹ˆà¸­à¸™à¹„à¸§à¹‰à¹ƒà¸™à¸•à¸­à¸™à¹à¸£à¸ */
        }

        #backButton {
            width: 100px;
            height: 30px;
            padding: 8px 15px;
            font-size: 10px;
            align-items: center;
            background-color: #3a5878;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #backButton:hover {
            background-color: #3a5878b9;
        }

        /* à¸ªà¹„à¸•à¸¥à¹Œà¸ªà¸³à¸«à¸£à¸±à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™ */
        #notification {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 10px 10px 10px;
            border-radius: 8px;
            text-align: center;
            align-items: center;
            font-size: 12px;
            z-index: 120;
            display: none;
            /* à¸‹à¹ˆà¸­à¸™à¹„à¸§à¹‰à¹ƒà¸™à¸•à¸­à¸™à¹à¸£à¸ */
            animation: fadeInOut 2s forwards;
            /* à¹€à¸à¸´à¹ˆà¸¡ animation */
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            80% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }


        .menu-icon {
            cursor: pointer;
            font-size: 32px;
            color: #000000;
            user-select: none;
            padding: 10px;
            position: fixed;
            top: 9.9px;
            left: 10px;
            z-index: 1000;
            border-radius: 6px;
        }

        .menu-icon:hover {
            color: #53525286;
        }

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 150px;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.85);
            padding-top: 70px;
            display: flex;
            flex-direction: column;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 999;
        }

        .navbar.show {
            transform: translateX(0);
        }


        .navbar a {
            color: #fff;
            text-decoration: none;
            padding: 12px 20px;
            font-size: 15px;
            transition: 0.2s;
        }

        .navbar a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffd700;
        }

    
    </style>
</head>

<body>

    Â  Â  <div class="menu-icon" onclick="toggleMenu()">â˜°</div>
    Â  Â  <div class="navbar" id="navbar">
        Â  Â  Â  Â  <a href="main.html">ğŸ  à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</a>
        Â  Â  Â  Â  <a href="Bus lines.html">ğŸšŒ à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸ªà¸²à¸¢à¸£à¸–à¹€à¸¡à¸¥à¹Œ</a>
        Â  Â  Â  Â  <a href="van lines.html">ğŸš à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸ªà¸²à¸¢à¸•à¸¹à¹‰</a>
        Â  Â  Â  Â  <a href="index.html">à¸«à¸™à¹‰à¸²à¸„à¹‰à¸™à¸«à¸²</a>
        Â  Â  Â  Â  <a href="test.html">à¸”à¸¹à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¹€à¸”à¸´à¸™à¸£à¸–538</a>
        Â  Â  Â  Â  <a href="https://www.route.in.th/
Â  Â  Â  Â  Â  Â  ">ğŸŒ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸²à¸¢à¸£à¸–</a>
        Â  Â  Â  Â  <a href="https://maps.google.com/">ğŸ—ºï¸ à¹à¸œà¸™à¸—à¸µà¹ˆ</a>
        Â  Â  Â  Â  <a href="#">ğŸ” à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</a>
        Â  Â  </div>

    Â  Â  <div id="targetCircle"></div>

    Â  Â  <div id="map-container">
        Â  Â  Â  Â  <canvas id="routeCanvas"></canvas>
        Â  Â  Â  Â  <div id="bus"></div>
        Â  Â  Â  Â  <div id="notification"></div>
        <div id="userLocationCircle"></div> Â  Â 
    </div>

    Â  Â  <div id="controls">
        Â  Â  Â  Â  <p>à¸„à¸¥à¸´à¸à¸šà¸™à¹à¸œà¸™à¸—à¸µà¹ˆà¹€à¸à¸·à¹ˆà¸­à¸à¸³à¸«à¸™à¸”à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡ à¸«à¸£à¸·à¸­à¹‚à¸«à¸¥à¸”à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸—à¸µà¹ˆà¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸§à¹‰</p>
        Â  Â  Â  Â  <button id="resetRoute">à¸£à¸µà¹€à¸‹à¹‡à¸•à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡</button>
        Â  Â  Â  Â  <button id="startAnimation">à¹€à¸£à¸´à¹ˆà¸¡/à¸«à¸¢à¸¸à¸” à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™</button>
        Â  Â  Â  Â  <button id="saveAndDisplay">à¸šà¸±à¸™à¸—à¸¶à¸ & à¹à¸ªà¸”à¸‡à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™</button>
        Â  Â  Â  Â  <button id="loadRoute">à¹‚à¸«à¸¥à¸”à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡</button>
        <button id="markUserLocation"></button> Â  Â 
    </div>

    Â  Â  <div id="backButtonContainer">
        Â  Â  Â  Â  <button id="backButton">à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸š</button>
        Â  Â  </div>

    Â  Â 
    <script>
        /* JavaScript code */
        document.addEventListener('DOMContentLoaded', () => {
            const bus = document.getElementById('bus');
            const canvas = document.getElementById('routeCanvas');
            const ctx = canvas.getContext('2d');
            const mapContainer = document.getElementById('map-container');
            const controlsDiv = document.getElementById('controls');
            const backButtonContainer = document.getElementById('backButtonContainer');
            const notificationDiv = document.getElementById('notification'); // à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸–à¸¶à¸‡ div à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™
            const targetCircle = document.getElementById('targetCircle'); // à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸–à¸¶à¸‡à¸§à¸‡à¸à¸¥à¸¡à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢
            const userLocationCircle = document.getElementById('userLocationCircle'); // New: Reference to user's location circle

            const resetRouteBtn = document.getElementById('resetRoute');
            const startAnimationBtn = document.getElementById('startAnimation');
            const saveAndDisplayBtn = document.getElementById('saveAndDisplay');
            const loadRouteBtn = document.getElementById('loadRoute');
            const backButton = document.getElementById('backButton');
            const markUserLocationBtn = document.getElementById('markUserLocation'); // New: Reference to the new button

            canvas.width = 600;
            canvas.height = 400;

            let routeCoordinates = [];
            let currentPointIndex = 0;
            let animationFrameId;
            let position = { x: 0, y: 0 };
            const speed = 0.2; // 
            let isAnimating = false;
            const LOCAL_STORAGE_KEY = 'savedRoutePoints';

            let isDisplayMode = false;
            let userMarkedLocation = null; // To store the user's marked location

            // à¸à¸´à¸à¸±à¸”à¸‚à¸­à¸‡à¸§à¸‡à¸à¸¥à¸¡à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢ (à¸ªà¸²à¸¡à¸²à¸£à¸–à¸›à¸£à¸±à¸šà¹„à¸”à¹‰à¸•à¸²à¸¡à¸•à¹‰à¸­à¸‡à¸à¸²à¸£)
            // à¸„à¸§à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸à¸´à¸à¸±à¸”à¹ƒà¸«à¹‰à¸ªà¸±à¸¡à¸à¸±à¸™à¸˜à¹Œà¸à¸±à¸š map-container
            const targetCirclePosition = { x: 450, y: 150 }; // à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡: à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸—à¸µà¹ˆ 450px à¸ˆà¸²à¸à¸‹à¹‰à¸²à¸¢, 150px à¸ˆà¸²à¸à¸šà¸™
            targetCircle.style.left = `${targetCirclePosition.x}px`;
            targetCircle.style.top = `${targetCirclePosition.y}px`;


            let hasNotifiedTargetCircle = false; // à¸ªà¸–à¸²à¸™à¸°à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¹€à¸¡à¸·à¹ˆà¸­à¹‚à¸”à¸™à¸§à¸‡à¸à¸¥à¸¡à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢

            // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™
            function showNotification(message) {
                notificationDiv.textContent = message;
                notificationDiv.style.display = 'block';
                notificationDiv.style.animation = 'none'; // à¸£à¸µà¹€à¸‹à¹‡à¸• animation
                void notificationDiv.offsetWidth; // Trigger reflow
                notificationDiv.style.animation = 'fadeInOut 2s forwards'; // à¹€à¸£à¸´à¹ˆà¸¡ animation à¹ƒà¸«à¸¡à¹ˆ
                setTimeout(() => {
                    notificationDiv.style.display = 'none';
                }, 2000); // à¸‹à¹ˆà¸­à¸™à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸ 2 à¸§à¸´à¸™à¸²à¸—à¸µ (à¹€à¸—à¹ˆà¸²à¸à¸±à¸šà¸£à¸°à¸¢à¸°à¹€à¸§à¸¥à¸² animation)
            }

            function drawRoute() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (routeCoordinates.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(routeCoordinates[0].x, routeCoordinates[0].y);

                    for (let i = 1; i < routeCoordinates.length; i++) {
                        ctx.lineTo(routeCoordinates[i].x, routeCoordinates[i].y);
                    }

                    ctx.strokeStyle = '#0000FF'; // à¸ªà¸µà¹€à¸ªà¹‰à¸™ (à¸™à¹‰à¸³à¹€à¸‡à¸´à¸™)
                    ctx.lineWidth = 4; // à¸„à¸§à¸²à¸¡à¸«à¸™à¸²à¸‚à¸­à¸‡à¹€à¸ªà¹‰à¸™
                    ctx.lineJoin = 'round';
                    ctx.stroke();
                }

                if (!isDisplayMode) {
                    for (const point of routeCoordinates) {
                        ctx.beginPath();
                        ctx.arc(point.x, point.y, 6, 0, Math.PI * 2); // à¸§à¸‡à¸à¸¥à¸¡à¸£à¸±à¸¨à¸¡à¸µ 6px
                        ctx.fillStyle = '#ffffff'; // à¸ªà¸µà¸‚à¸²à¸§
                        ctx.fill();
                        ctx.strokeStyle = '#333';
                        ctx.lineWidth = 1;
                        ctx.stroke();
                    }
                }
            }

            function animateBus() {
                if (!isAnimating || routeCoordinates.length < 2) {
                    animationFrameId = requestAnimationFrame(animateBus);
                    return;
                }

                const target = routeCoordinates[currentPointIndex];
                const dx = target.x - position.x;
                const dy = target.y - position.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance <= speed) {
                    position.x = target.x;
                    position.y = target.y;
                    bus.style.left = `${position.x}px`;
                    bus.style.top = `${position.y}px`;

                    currentPointIndex++;
                    if (currentPointIndex >= routeCoordinates.length) {
                        currentPointIndex = 0; // à¸§à¸™à¸à¸¥à¸±à¸šà¹„à¸›à¸ˆà¸¸à¸”à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
                        hasNotifiedTargetCircle = false; // à¸£à¸µà¹€à¸‹à¹‡à¸•à¸ªà¸–à¸²à¸™à¸°à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¹€à¸¡à¸·à¹ˆà¸­à¸„à¸£à¸šà¸£à¸­à¸š

                        bus.classList.add('hidden');

                        if (routeCoordinates.length > 0) {
                            position.x = routeCoordinates[0].x;
                            position.y = routeCoordinates[0].y;
                            bus.style.left = `${position.x}px`;
                            bus.style.top = `${position.y}px`;
                        } else {
                            position.x = 0;
                            position.y = 0;
                            bus.style.left = `0px`;
                            bus.style.top = `0px`;
                        }

                        setTimeout(() => {
                            bus.classList.remove('hidden');
                            if (routeCoordinates.length < 2 && isAnimating) {
                                isAnimating = false;
                                startAnimationBtn.textContent = 'à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™';
                            }
                        }, 50);
                    }
                } else {
                    position.x += (dx / distance) * speed;
                    position.y += (dy / distance) * speed;
                    bus.style.left = `${position.x}px`;
                    bus.style.top = `${position.y}px`;
                }

                // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¸Šà¸™à¸à¸±à¸™à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ bus à¹à¸¥à¸° targetCircle
                checkCollision();
                checkUserLocationCollision(); // New: Check collision with user's marked location

                animationFrameId = requestAnimationFrame(animateBus);
            }

            function checkCollision() {
                if (hasNotifiedTargetCircle) return; // à¸–à¹‰à¸²à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¹„à¸›à¹à¸¥à¹‰à¸§ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸­à¸µà¸

                const busRect = bus.getBoundingClientRect();
                const targetCircleRect = targetCircle.getBoundingClientRect();

                // à¸›à¸£à¸±à¸šà¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¹ƒà¸«à¹‰à¸ªà¸±à¸¡à¸à¸±à¸™à¸˜à¹Œà¸à¸±à¸š map-container à¹€à¸™à¸·à¹ˆà¸­à¸‡à¸ˆà¸²à¸ bus à¹à¸¥à¸° targetCircle à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ map-container
                const busX = position.x;
                const busY = position.y;
                const targetX = targetCirclePosition.x; // à¹ƒà¸Šà¹‰à¸à¸´à¸à¸±à¸”à¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸”à¹„à¸§à¹‰
                const targetY = targetCirclePosition.y; // à¹ƒà¸Šà¹‰à¸à¸´à¸à¸±à¸”à¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸”à¹„à¸§à¹‰

                // à¸£à¸±à¸¨à¸¡à¸µà¸‚à¸­à¸‡ bus à¹à¸¥à¸° targetCircle (à¸«à¸²à¸£ 2 à¹€à¸™à¸·à¹ˆà¸­à¸‡à¸ˆà¸²à¸ width/height à¸„à¸·à¸­à¹€à¸ªà¹‰à¸™à¸œà¹ˆà¸²à¸™à¸¨à¸¹à¸™à¸¢à¹Œà¸à¸¥à¸²à¸‡)
                const busRadius = bus.offsetWidth / 2;
                const targetCircleRadius = targetCircle.offsetWidth / 2;

                // à¸„à¸³à¸™à¸§à¸“à¸£à¸°à¸¢à¸°à¸«à¹ˆà¸²à¸‡à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸ˆà¸¸à¸”à¸¨à¸¹à¸™à¸¢à¹Œà¸à¸¥à¸²à¸‡à¸‚à¸­à¸‡à¸§à¸‡à¸à¸¥à¸¡à¸—à¸±à¹‰à¸‡à¸ªà¸­à¸‡
                const distanceX = busX - targetX;
                const distanceY = busY - targetY;
                const distanceBetweenCenters = Math.sqrt(distanceX * distanceX + distanceY * distanceY);

                // à¸–à¹‰à¸²à¸Šà¸™à¸à¸±à¸™ (à¸£à¸°à¸¢à¸°à¸«à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢à¸à¸§à¹ˆà¸²à¸«à¸£à¸·à¸­à¹€à¸—à¹ˆà¸²à¸à¸±à¸šà¸œà¸¥à¸£à¸§à¸¡à¸‚à¸­à¸‡à¸£à¸±à¸¨à¸¡à¸µ)
                if (distanceBetweenCenters <= (busRadius + targetCircleRadius)) {
                    showNotification('à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“');
                    hasNotifiedTargetCircle = true; // à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸ªà¸–à¸²à¸™à¸°à¸§à¹ˆà¸²à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¹à¸¥à¹‰à¸§
                }
            }

            // New: Function to check collision with user's marked location
            function checkUserLocationCollision() {
                if (!userMarkedLocation || userLocationCircle.style.display === 'none') return;

                const busRadius = bus.offsetWidth / 2;
                const userCircleRadius = userLocationCircle.offsetWidth / 2;

                const distanceX = position.x - userMarkedLocation.x;
                const distanceY = position.y - userMarkedLocation.y;
                const distanceBetweenCenters = Math.sqrt(distanceX * distanceX + distanceY * distanceY);

                if (distanceBetweenCenters <= (busRadius + userCircleRadius)) {
                    showNotification('à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“ (à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰)');
                    // You might want to remove the user location circle after notification or keep it
                    // userLocationCircle.style.display = 'none';
                    userMarkedLocation = null; // Reset marked location after collision
                }
            }


            function setDisplayMode(enabled) {
                isDisplayMode = enabled;
                if (enabled) {
                    controlsDiv.style.display = 'none';
                    backButtonContainer.style.display = 'block';
                    mapContainer.style.cursor = 'default';
                    if (routeCoordinates.length >= 2 && !isAnimating) {
                        isAnimating = true;
                        currentPointIndex = 0;
                        position = { x: routeCoordinates[0].x, y: routeCoordinates[0].y };
                        bus.style.left = `${position.x}px`;
                        bus.style.top = `${position.y}px`;
                        bus.classList.remove('hidden');
                        hasNotifiedTargetCircle = false; // à¸£à¸µà¹€à¸‹à¹‡à¸•à¸ªà¸–à¸²à¸™à¸°à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¹‚à¸«à¸¡à¸”à¹à¸ªà¸”à¸‡à¸œà¸¥à¹ƒà¸«à¸¡à¹ˆ
                    } else if (routeCoordinates.length < 2) {
                        bus.classList.add('hidden');
                        isAnimating = false;
                    }
                } else {
                    controlsDiv.style.display = 'block';
                    backButtonContainer.style.display = 'none';
                    mapContainer.style.cursor = 'crosshair';
                    isAnimating = false;
                    startAnimationBtn.textContent = 'à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™';
                    hasNotifiedTargetCircle = false; // à¸£à¸µà¹€à¸‹à¹‡à¸•à¸ªà¸–à¸²à¸™à¸°à¹€à¸¡à¸·à¹ˆà¸­à¸­à¸­à¸à¸ˆà¸²à¸à¹‚à¸«à¸¡à¸”à¹à¸ªà¸”à¸‡à¸œà¸¥
                }
                drawRoute();
            }

            mapContainer.addEventListener('click', (event) => {
                if (isDisplayMode) return;

                const rect = mapContainer.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                routeCoordinates.push({ x: x, y: y });
                drawRoute();

                if (routeCoordinates.length === 1) {
                    position.x = x;
                    position.y = y;
                    bus.style.left = `${position.x}px`;
                    bus.style.top = `${position.y}px`;
                    bus.classList.remove('hidden');
                }
            });

            // Event Listener à¸ªà¸³à¸«à¸£à¸±à¸šà¸„à¸¥à¸´à¸à¸—à¸µà¹ˆà¸§à¸‡à¸à¸¥à¸¡à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢
            targetCircle.addEventListener('click', () => {
                showNotification('à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“');
            });

            // New: Event Listener for the "Mark Your Location" button
            markUserLocationBtn.addEventListener('click', () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((geoPosition) => {
                        const mapRect = mapContainer.getBoundingClientRect();
                        // Assuming the map is 600x400, we need to scale the actual lat/lng
                        // This is a very simplified mapping and might not be accurate for real-world coordinates
                        // For a real map, you'd use a library like Leaflet or Google Maps API
                        const scaleX = canvas.width / mapRect.width;
                        const scaleY = canvas.height / mapRect.height;

                        // This is a placeholder for how you *might* map a real lat/lng to your pixel map.
                        // In a real scenario, you'd need a more robust coordinate transformation.
                        // For demonstration, we'll just place it randomly if geoPosition is not accurate.
                        const userX = (geoPosition.coords.longitude + 180) / 360 * canvas.width; // Placeholder mapping
                        const userY = (90 - geoPosition.coords.latitude) / 180 * canvas.height; // Placeholder mapping

                        // If the map is fixed, you might want to pick a central point or a logical starting point
                        // For this simulation, we'll just place it somewhere if it's the first click.
                        const x = userX || mapContainer.offsetWidth / 2;
                        const y = userY || mapContainer.offsetHeight / 2;

                        userMarkedLocation = { x: x, y: y };
                        userLocationCircle.style.left = `${userMarkedLocation.x}px`;
                        userLocationCircle.style.top = `${userMarkedLocation.y}px`;
                        userLocationCircle.style.display = 'block';
                        showNotification('à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸–à¸¹à¸à¸¡à¸²à¸£à¹Œà¸à¹à¸¥à¹‰à¸§');
                    }, (error) => {
                        console.error('Error getting geolocation:', error);
                        alert('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸£à¸°à¸šà¸¸à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¸‚à¸­à¸‡à¸„à¸¸à¸“à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸«à¸£à¸·à¸­à¸­à¸™à¸¸à¸à¸²à¸•à¸à¸²à¸£à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡.');
                        // Fallback: If geolocation fails, allow manual marking on the map
                        alert('à¸„à¸¸à¸“à¸ªà¸²à¸¡à¸²à¸£à¸–à¸„à¸¥à¸´à¸à¸šà¸™à¹à¸œà¸™à¸—à¸µà¹ˆà¹€à¸à¸·à¹ˆà¸­à¸à¸³à¸«à¸™à¸”à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸”à¹‰à¸§à¸¢à¸•à¸™à¹€à¸­à¸‡à¹„à¸”à¹‰');
                        mapContainer.style.cursor = 'crosshair'; // Change cursor to allow clicking
                        mapContainer.removeEventListener('click', addPointToRoute); // Remove route clicking listener
                        mapContainer.addEventListener('click', setUserManualLocation); // Add manual location listener
                    });
                } else {
                    alert('à¹€à¸šà¸£à¸²à¸§à¹Œà¹€à¸‹à¸­à¸£à¹Œà¸‚à¸­à¸‡à¸„à¸¸à¸“à¹„à¸¡à¹ˆà¸£à¸­à¸‡à¸£à¸±à¸š Geolocation. à¸„à¸¸à¸“à¸ªà¸²à¸¡à¸²à¸£à¸–à¸„à¸¥à¸´à¸à¸šà¸™à¹à¸œà¸™à¸—à¸µà¹ˆà¹€à¸à¸·à¹ˆà¸­à¸à¸³à¸«à¸™à¸”à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸”à¹‰à¸§à¸¢à¸•à¸™à¹€à¸­à¸‡à¹„à¸”à¹‰');
                    mapContainer.style.cursor = 'crosshair';
                    mapContainer.removeEventListener('click', addPointToRoute);
                    mapContainer.addEventListener('click', setUserManualLocation);
                }
            });

            // New: Function for manually setting user location if geolocation is not available
            function setUserManualLocation(event) {
                const rect = mapContainer.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                userMarkedLocation = { x: x, y: y };
                userLocationCircle.style.left = `${userMarkedLocation.x}px`;
                userLocationCircle.style.top = `${userMarkedLocation.y}px`;
                userLocationCircle.style.display = 'block';
                showNotification('à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸–à¸¹à¸à¸¡à¸²à¸£à¹Œà¸à¹à¸¥à¹‰à¸§ (à¸à¸³à¸«à¸™à¸”à¹€à¸­à¸‡)');

                // After marking, revert cursor and original map click listener
                mapContainer.style.cursor = 'default';
                mapContainer.removeEventListener('click', setUserManualLocation);
                mapContainer.addEventListener('click', addPointToRoute);
            }

            // A helper function to ensure the original map click listener works when not in manual location mode
            function addPointToRoute(event) {
                const rect = mapContainer.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                routeCoordinates.push({ x: x, y: y });
                drawRoute();

                if (routeCoordinates.length === 1) {
                    position.x = x;
                    position.y = y;
                    bus.style.left = `${position.x}px`;
                    bus.style.top = `${position.y}px`;
                    bus.classList.remove('hidden');
                }
            }


            resetRouteBtn.addEventListener('click', () => {
                routeCoordinates = [];
                currentPointIndex = 0;
                isAnimating = false;
                startAnimationBtn.textContent = 'à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™';
                bus.classList.add('hidden');
                position = { x: 0, y: 0 };
                drawRoute();
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                hasNotifiedTargetCircle = false; // à¸£à¸µà¹€à¸‹à¹‡à¸•à¸ªà¸–à¸²à¸™à¸°à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™
                userLocationCircle.style.display = 'none'; // Hide user's marked location
                userMarkedLocation = null; // Clear user's marked location
                alert('à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸–à¸¹à¸à¸£à¸µà¹€à¸‹à¹‡à¸•à¹à¸¥à¸°à¸¥à¸šà¸ˆà¸²à¸à¸«à¸™à¹ˆà¸§à¸¢à¸„à¸§à¸²à¸¡à¸ˆà¸³à¹à¸¥à¹‰à¸§!');
            });

            startAnimationBtn.addEventListener('click', () => {
                if (routeCoordinates.length < 2) {
                    alert('à¸à¸£à¸¸à¸“à¸²à¸à¸³à¸«à¸™à¸”à¸ˆà¸¸à¸”à¸šà¸™à¹à¸œà¸™à¸—à¸µà¹ˆà¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 2 à¸ˆà¸¸à¸”à¸à¹ˆà¸­à¸™à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™');
                    return;
                }
                isAnimating = !isAnimating;
                if (isAnimating) {
                    startAnimationBtn.textContent = 'à¸«à¸¢à¸¸à¸”à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™';
                    if (currentPointIndex === 0 && (position.x !== routeCoordinates[0].x || position.y !== routeCoordinates[0].y)) {
                        position = { x: routeCoordinates[0].x, y: routeCoordinates[0].y };
                        bus.style.left = `${position.x}px`;
                        bus.style.top = `${position.y}px`;
                        bus.classList.remove('hidden');
                    }
                    hasNotifiedTargetCircle = false; // à¸£à¸µà¹€à¸‹à¹‡à¸•à¸ªà¸–à¸²à¸™à¸°à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™à¹ƒà¸«à¸¡à¹ˆ
                } else {
                    startAnimationBtn.textContent = 'à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™';
                }
            });

            saveAndDisplayBtn.addEventListener('click', () => {
                if (routeCoordinates.length < 2) {
                    alert('à¸à¸£à¸¸à¸“à¸²à¸à¸³à¸«à¸™à¸”à¸ˆà¸¸à¸”à¸šà¸™à¹à¸œà¸™à¸—à¸µà¹ˆà¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 2 à¸ˆà¸¸à¸”à¹€à¸à¸·à¹ˆà¸­à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¸°à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™');
                    return;
                }
                try {
                    const routeString = JSON.stringify(routeCoordinates);
                    localStorage.setItem(LOCAL_STORAGE_KEY, routeString);
                    alert('à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§! à¸à¸³à¸¥à¸±à¸‡à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¹‚à¸«à¸¡à¸”à¹à¸ªà¸”à¸‡à¸œà¸¥');
                    setDisplayMode(true);
                } catch (e) {
                    alert('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡: ' + e);
                }
            });

            loadRouteBtn.addEventListener('click', () => {
                setDisplayMode(false);
                if (loadSavedRoute()) {
                    alert('à¹‚à¸«à¸¥à¸”à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§! à¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™à¹„à¸”à¹‰');
                } else {
                    alert('à¹„à¸¡à¹ˆà¸à¸šà¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸—à¸µà¹ˆà¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸§à¹‰');
                }
            });

            backButton.addEventListener('click', () => {
                setDisplayMode(false);
            });

            function loadSavedRoute() {
                try {
                    const savedRouteString = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (savedRouteString) {
                        const loadedRoute = JSON.parse(savedRouteString);
                        if (loadedRoute.length > 0) {
                            routeCoordinates = loadedRoute;
                            drawRoute();
                            currentPointIndex = 0;
                            position = { x: routeCoordinates[0].x, y: routeCoordinates[0].y };
                            bus.style.left = `${position.x}px`;
                            bus.style.top = `${position.y}px`;
                            bus.classList.remove('hidden');
                            isAnimating = false;
                            startAnimationBtn.textContent = 'à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™';
                            hasNotifiedTargetCircle = false; // à¸£à¸µà¹€à¸‹à¹‡à¸•à¸ªà¸–à¸²à¸™à¸°à¹€à¸¡à¸·à¹ˆà¸­à¹‚à¸«à¸¥à¸”à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡
                            return true;
                        } else {
                            return false;
                        }
                    } else {
                        return false;
                    }
                } catch (e) {
                    console.error('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹‚à¸«à¸¥à¸”à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡: ', e);
                    return false;
                }
            }

            if (loadSavedRoute()) {
                setDisplayMode(true);
            } else {
                setDisplayMode(false);
            }

            animateBus();
        });

        function toggleMenu() {
            const navbar = document.getElementById("navbar");
            navbar.classList.toggle("show");
        }
    </script>
</body>

</html>
